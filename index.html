<!DOCTYPE html>
<html>
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>




  <!-- we import arjs version without NFT but with marker + location based support -->
  <script src="aframe-ar.js"></script>
  <style>
  .buttons {
     position: absolute;
     bottom: 0;
     left: 0;
     width: 100%;
     height: 5em;
     display: flex;
     justify-content: center;
     align-items: center;
     z-index: 10;
   }

   .startBtn{
     padding: 0.25em;
     border-radius: 4px;
     border: none;
     background: white;
     color: black;
     width: 4em;
     height: 2em;
   }

   #compass-data{
     font-family: sans-serif;
     color:white;
   }

   a-scene{}

     #krpano {
       width:100%;
       height:100%;
       display:none;
     }

  </style>
  <script>
  //So I can see in the console log if the updated version is running...
  console.log("*************")
  console.log("Update 66")
  console.log("*************")





  //Multiple Trackers
  AFRAME.registerComponent('registerevents', {
  		init: function () {
  			var marker = this.el;
        var markerId = marker.id;

  			marker.addEventListener('markerFound', function() {

  				console.log('markerFound', markerId);

          if (markerId == "anchor") {
  				// TODO: Add your own code here to react to the marker being found.
        //  alert("Marker Found!");
          updatedURL = "https://dboxtest.s3.amazonaws.com/autogyro/tour.html?startscene=1&startactions=lookat(" + finalHeading.toString() + ",2.95,100,0,0)";
          console.log(updatedURL);
          window.open(updatedURL,"_self");

        } else if (markerId == "anchor2") {
          //window.open("https://dboxtest.s3.amazonaws.com/autogyro/tour.html?startscene=1&startactions=lookat(90,2.95,100,0,0)","_self");
          const cameraFeed = document.querySelector("#arjs-video");
          const aframeScene = document.querySelector("#aframeScene")
          const krPano = document.querySelector("#krpano")
          cameraFeed.style.display = "none";
          aframeScene.style.display = "none";
          krPano.style.display = "block";

        } else {}

  			});



  			marker.addEventListener('markerLost', function() {
  				var markerId = marker.id;
  				console.log('markerLost', markerId);
  				// TODO: Add your own code here to react to the marker being lost.
  			});
  		}
  	});




  </script>


  <body style="margin: 0px; overflow: hidden;">

    <div class="buttons">
      <button class="start-btn">Start compass</button>
      <p id="compass-data">0</p>
    </div>

    <a-scene embedded arjs vr-mode-ui="enabled: false" id="aframeScene">

      <a-marker preset='custom' type="pattern" url="pattern-Main_111_Murray_3.patt" emitevents="true" id="anchor" registerevents >
      </a-marker>

      <a-marker preset='hiro' emitevents="true" id="anchor2" registerevents>
      </a-marker>

     <a-entity camera></a-entity>
  </a-scene>

  <iframe id="krpano" src="https://dboxtest.s3.amazonaws.com/autogyro/tour.html?startscene=1&startactions=lookat(90,2.95,100,0,0)"
    frameborder="0" allowvr="yes" allow="vr; xr; accelerometer https://dboxtest.s3.amazonaws.com;
    magnetometer; gyroscope https://dboxtest.s3.amazonaws.com; autoplay;" allowfullscreen
    mozallowfullscreen="true"
    webkitallowfullscreen="true">

  </iframe>

  </body>

  <script>
  //Compass Section
  const startBtn = document.querySelector(".start-btn");

  let compass;
  let adjustment = -20; //For magnetic north adjustment to city grid etc.
  let finalHeading;

  const isIOS = (
  navigator.userAgent.match(/(iPod|iPhone|iPad)/) &&
  navigator.userAgent.match(/AppleWebKit/)
  );

  console.log("isIOS:")
  console.log(isIOS);
  //Have to have a button somewhere to start the compass on iOS
  function init() {
    startBtn.addEventListener("click", startCompass);
    console.log("Init function started...")
  }

  function startCompass() {
    console.log("Button Pressed...")
    if (isIOS) {
      DeviceOrientationEvent.requestPermission()
        .then((response) => {
          if (response === "granted") {
            console.log("iOS permission granted...");
            window.addEventListener("deviceorientation", handler, true);
          } else {
            alert("has to be allowed!");
          }
        })
        .catch(() => alert("not supported"));
    } else {
      console.log("Device is not iOS...");
      window.addEventListener("deviceorientationabsolute", handler, true);
    }
  }

const compassDisplay = document.querySelector("#compass-data");

  function handler(e) {
    compass = e.webkitCompassHeading;

    finalHeading = compass + adjustment;

    if (finalHeading > 360) {
      finalHeading = finalHeading - 360;
    }

    if (finalHeading < 0) {
      finalHeading = 360 - Math.abs(finalHeading);
    }

    compassDisplay.innerHTML = finalHeading.toString();
    console.log("Compass Heading:");
    console.log(compass);
    console.log("Adjusted Heading:");
    console.log(finalHeading);
  }

  init();

  </script>


</html>
